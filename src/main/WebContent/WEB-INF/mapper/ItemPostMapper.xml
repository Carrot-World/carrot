<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.carrot.repository.ItemPostRepository">
    <insert id="insert" parameterType="com.carrot.domain.ItemPostVO"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        insert into item_post values(item_post_id.nextval, #{title}, #{content}, #{loc1}, #{loc2}, #{loc3},
        #{writer}, 0, #{price}, 0, #{category_id}, #{created_at}, #{hart_cnt})
    </insert>

    <update id="update" parameterType="com.carrot.domain.ItemPostVO">
        update ITEM_POST set TITLE = #{title}, CONTENT = #{content}, PRICE = #{price}, CATEGORY_ID = #{category_id}
        where id = #{id}
    </update>

    <select id="selectCount" parameterType="com.carrot.domain.SearchVO" resultType="int">
        select count(*) from item_post
        <where>
            <if test="category_id != 0">
                category_id = #{category_id}
            </if>
            <if test="loc1 != null">
                and loc1 = #{loc1}
            </if>
            <if test="loc2 != null">
                and loc2 = #{loc2}
            </if>
            <if test="loc3 != null">
                and loc3 = #{loc3}
            </if>
            <if test="title != null">
                and title like '%' || #{title} || '%'
            </if>
        </where>
    </select>

    <select id="selectById" resultType="com.carrot.domain.ItemPostVO" parameterType="int">
        select item.id,
        item.title,
        item.content,
        item.loc1,
        item.loc2,
        item.loc3,
        item.writer,
        item.chat_cnt,
        item.price,
        item.status,
        item.category_id,
        item.created_at,
        item.hart_cnt,
        writer.NICKNAME as writer_nickname
        from item_post item,
        USER_INFO writer
        where item.Writer = writer.ID
        and item.id = #{id}
    </select>

    <select id="selectByWriter" resultType="com.carrot.domain.ItemPostVO">
        select * from ITEM_POST where writer = #{writer}
    </select>

    <select id="search" resultType="com.carrot.domain.ItemPostVO" parameterType="com.carrot.domain.SearchVO">
        select * from item_post
        <where>
            <if test="category_id != 0">
                category_id = #{category_id}
            </if>
            <if test="loc1 != null">
                and loc1 = #{loc1}
            </if>
            <if test="loc2 != null">
                and loc2 = #{loc2}
            </if>
            <if test="loc3 != null">
                and loc3 = #{loc3}
            </if>
            <if test="title != null">
                and title like '%' || #{title} || '%'
            </if>
        </where>
        order by id desc offset #{pageStartCnt} rows fetch first #{pageSize} rows only
    </select>

    <update id="hartPlus" parameterType="com.carrot.domain.HartVO">
        update ITEM_POST set HART_CNT = HART_CNT + 1 where id = #{item_post_id}
    </update>

    <update id="hartMinus" parameterType="com.carrot.domain.HartVO">
        update ITEM_POST set HART_CNT = HART_CNT
        <if test="cnt > 0">
            - 1 where id = #{item_post_id}
        </if>
        <if test="cnt == 0">
            where id = 0
        </if>
    </update>
</mapper>